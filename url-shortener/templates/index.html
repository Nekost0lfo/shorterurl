<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîó URL Shortener</h1>
            <p>–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å Docker</p>
        </header>

        <main>
            <div class="shortener-form">
                <input type="url" id="urlInput" placeholder="https://example.com" required>
                <button onclick="shortenUrl()">–°–æ–∫—Ä–∞—Ç–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>

            <div id="result" class="result hidden">
                <h3>–í–∞—à–∞ –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:</h3>
                <div class="short-url">
                    <a id="shortLink" href="" target="_blank"></a>
                    <button onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="stats-link">
                    <a id="statsLink" href="">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                </div>
            </div>

            <div id="error" class="error hidden">
                <p id="errorMessage"></p>
            </div>

            <div class="health-check">
                <button onclick="checkHealth()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</button>
                <div id="healthStatus" class="health-status hidden"></div>
            </div>
        </main>
    </div>

    <script>
        async function shortenUrl() {
            const urlInput = document.getElementById('urlInput');
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('error');
            const url = urlInput.value.trim();

            if (!url) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
                return;
            }

            try {
                const response = await fetch('/shorten', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();

                if (response.ok) {
                    hideError();
                    displayResult(data);
                } else {
                    showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            const shortLink = document.getElementById('shortLink');
            const statsLink = document.getElementById('statsLink');

            shortLink.href = data.short_url;
            shortLink.textContent = data.short_url;
            
            statsLink.href = `/stats/${data.short_code}`;
            
            resultDiv.classList.remove('hidden');
        }

        function copyToClipboard() {
            const shortLink = document.getElementById('shortLink');
            navigator.clipboard.writeText(shortLink.href)
                .then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                });
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const healthStatus = document.getElementById('healthStatus');
                healthStatus.innerHTML = `
                    <h4>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:</h4>
                    <ul>
                        <li>–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å: <span class="status-${data.main_service}">${data.main_service}</span></li>
                        <li>–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: <span class="status-${data.analytics_service}">${data.analytics_service}</span></li>
                        <li>–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: <span class="status-${data.notification_service}">${data.notification_service}</span></li>
                    </ul>
                `;
                healthStatus.classList.remove('hidden');
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            const resultDiv = document.getElementById('result');
            
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.add('hidden');
        }

        // Enter key support
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                shortenUrl();
            }
        });
    </script>
</body>
</html>